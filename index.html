<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CKT27BFGXB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-CKT27BFGXB');
    </script>
    <!-- End Google Analytics -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Add jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #050c16;
            color: #e9ecef;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #091428;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border: 1px solid #0f2547;
        }

        h1 {
            color: #4dabf7;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .credits-header {
            background-color: #0a1a30;
            color: white;
            text-align: center;
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            border: 1px solid #0f2547;
        }

        .credits-header a {
            color: #90caf9;
            text-decoration: none;
            margin: 0 10px;
            transition: color 0.3s;
        }

        .credits-header a:hover {
            color: white;
            text-decoration: underline;
        }

        .credits-header i {
            margin-right: 5px;
        }

        .search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 10px;
            color: #6c757d;
        }

        #searchInput {
            padding-left: 35px;
            border-radius: 20px;
            border: 1px solid #0f2547;
            background-color: #0a1a30;
            color: #e9ecef;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .table-responsive {
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            width: 100%;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #0f2547;
        }

        .table {
            margin-bottom: 0;
            min-width: 800px;
            /* Ensures table doesn't shrink too much */
        }

        .table thead th {
            background-color: #0a2351;
            color: white;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .table tbody tr {
            border-color: #0f2547;
        }

        .table tbody tr:nth-of-type(odd) {
            background-color: rgba(10, 35, 81, 0.2);
        }

        .table tbody tr:hover {
            background-color: rgba(25, 118, 210, 0.15);
        }

        .status-available {
            color: #4caf50;
            font-weight: bold;
        }

        .status-full {
            color: #f44336;
            font-weight: bold;
        }

        .last-updated {
            text-align: right;
            font-size: 0.9em;
            color: #90caf9;
            margin-bottom: 10px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #90caf9;
            font-style: italic;
        }

        /* Star feature styles */
        .star-column {
            width: 40px;
            text-align: center;
        }

        .star-btn {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            transition: color 0.2s;
            font-size: 1.2em;
        }

        .star-btn:hover {
            color: #ffc107;
        }

        .star-btn.starred {
            color: #ffc107;
        }

        .star-filter-toggle {
            text-align: center;
            margin-top: 10px;
        }

        .btn-outline-warning {
            color: #ffc107;
            border-color: #ffc107;
            background-color: transparent;
            transition: all 0.2s ease-out;
        }

        .btn-outline-warning:hover,
        .btn-outline-warning.active {
            color: #000;
            background-color: #ffc107;
        }

        .badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .badge-available {
            background-color: #1b5e20;
            color: #c8e6c9;
        }

        .badge-full {
            background-color: #b71c1c;
            color: #ffcdd2;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 150px;
        }

        .form-select {
            background-color: #0a1a30;
            color: #e9ecef;
            border-color: #0f2547;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 120px;
            background-color: #0a1a30;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
            border: 1px solid #0f2547;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4dabf7;
        }

        .stat-label {
            font-size: 0.9em;
            color: #90caf9;
        }

        /* Horizontal scrolling indicator for mobile */
        .scroll-indicator {
            display: none;
            text-align: center;
            color: #90caf9;
            margin-bottom: 10px;
            font-size: 0.8em;
        }

        /* Routine Generator Styles */
        .day-cell {
            font-weight: bold;
            background-color: #0a2351;
            width: 80px;
            /* Reduced width */
        }

        .course-cell {
            background-color: #0a1a30;
            border: 1px solid #0f2547;
            padding: 4px;
            /* Reduced padding */
            border-radius: 4px;
            font-size: 11px;
            /* Smaller font size */
        }

        .routine-container {
            overflow-x: auto;
        }

        #routineTable th {
            background-color: #0a2351;
            color: white;
            text-align: center;
            white-space: nowrap;
            padding: 4px;
            /* Reduced padding */
            font-size: 11px;
            /* Smaller font size */
        }

        #routineTable td {
            height: 60px;
            /* Reduced height */
            vertical-align: middle;
            text-align: center;
            padding: 2px;
            /* Minimal padding */
        }

        /* Abbreviate time slots in the header for more compact display */
        .time-abbr {
            display: block;
            font-size: 10px;
            line-height: 1.2;
        }

        /* Performance optimizations */
        .table-responsive {
            will-change: transform;
            transform: translateZ(0);
        }

        .star-btn {
            will-change: color;
            transform: translateZ(0);
        }

        /* Reduce repaints */
        .table tbody tr {
            transform: translateZ(0);
        }

        /* New styles for comparison feature */
        .comparison-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .btn-toggle {
            background-color: #0a1a30;
            color: #e9ecef;
            border: 1px solid #0f2547;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
            margin: 0 5px;
        }

        .btn-toggle.active {
            background-color: #1e88e5;
            color: white;
        }

        .btn-toggle:hover:not(.active) {
            background-color: #0f2547;
        }

        .change-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .change-increased {
            background-color: #4caf50;
        }

        .change-decreased {
            background-color: #f44336;
        }

        .change-none {
            background-color: #90a4ae;
        }

        .change-row {
            animation: highlight-change 2s ease-in-out;
        }

        /* Optimize animations */
        @keyframes highlight-change {
            0% {
                background-color: rgba(25, 118, 210, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }

        .changes-summary {
            background-color: #0a1a30;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #0f2547;
            display: none;
        }

        .changes-summary h5 {
            color: #4dabf7;
            margin-bottom: 15px;
        }

        .change-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {

            .filter-item,
            .stat-card {
                min-width: 100%;
            }

            .scroll-indicator {
                display: block;
            }

            /* Force table to be scrollable horizontally */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="credits-header">
            <span>Made with ❤️ by Rayed Riasat | </span>
            <a href="https://www.facebook.com/rayed.riasat.5" target="_blank"><i class="bi bi-facebook"></i>Facebook</a>
            <a href="https://www.linkedin.com/in/rayed-riasat-rabbi/" target="_blank"><i
                    class="bi bi-linkedin"></i>LinkedIn</a>
        </div>

        <h1>Course Information</h1>
        <div class="last-updated" id="lastUpdated"></div>

        <!-- Comparison toggle buttons -->
        <div class="comparison-toggle">
            <button id="viewCurrentBtn" class="btn-toggle active">View Current Data</button>
            <button id="viewChangesBtn" class="btn-toggle">View Changes</button>
        </div>

        <!-- Changes summary section -->
        <div class="changes-summary" id="changesSummary">
            <h5><i class="bi bi-arrow-repeat me-2"></i>Changes Summary</h5>
            <div class="change-stat" id="previousDataTimeContainer">
                <span>Comparing with data from:</span>
                <span id="previousDataTime">Loading...</span>
            </div>
            <div class="change-stat">
                <span>Courses that filled up:</span>
                <span id="filledUpCount">0</span>
            </div>
            <div class="change-stat">
                <span>Courses that opened up:</span>
                <span id="openedUpCount">0</span>
            </div>
            <div class="change-stat">
                <span>Courses with increased enrollment:</span>
                <span id="increasedCount">0</span>
            </div>
            <div class="change-stat">
                <span>Courses with decreased enrollment:</span>
                <span id="decreasedCount">0</span>
            </div>
            <div class="change-stat">
                <span>Total changes:</span>
                <span id="totalChangesCount">0</span>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="filters">
            <div class="filter-item">
                <select id="courseFilter" class="form-select">
                    <option value="">All Courses</option>
                </select>
            </div>
            <div class="filter-item">
                <select id="facultyFilter" class="form-select">
                    <option value="">All Faculty</option>
                </select>
            </div>
            <div class="filter-item">
                <select id="roomFilter" class="form-select">
                    <option value="">All Rooms</option>
                </select>
            </div>
            <div class="filter-item">
                <select id="statusFilter" class="form-select">
                    <option value="">All Status</option>
                    <option value="Available">Available</option>
                    <option value="Full">Full</option>
                </select>
            </div>
            <div class="filter-item" id="changeFilterContainer" style="display: none;">
                <select id="changeFilter" class="form-select">
                    <option value="">All Changes</option>
                    <option value="increased">Increased Enrollment</option>
                    <option value="decreased">Decreased Enrollment</option>
                    <option value="filledUp">Filled Up</option>
                    <option value="openedUp">Opened Up</option>
                    <option value="noChange">No Change</option>
                </select>
            </div>
        </div>

        <!-- Add Star Filter Toggle Button -->
        <div class="star-filter-toggle mb-3">
            <button id="viewStarredBtn" class="btn btn-outline-warning">
                <i class="bi bi-star-fill me-1"></i> View Starred Courses
            </button>
            <!-- Add Generate Routine Button -->
            <button id="generateRoutineBtn" class="btn btn-outline-primary ms-2">
                <i class="bi bi-calendar-week me-1"></i> Generate Routine
            </button>
        </div>

        <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Search for anything...">
        </div>

        <div class="scroll-indicator">
            <i class="bi bi-arrow-left-right"></i> Swipe horizontally to view all columns
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="courseTable">
                <thead>
                    <tr>
                        <th id="changeHeader" style="display: none;">Change</th>
                        <th>Star</th>
                        <th>Course Code</th>
                        <th>Section</th>
                        <th>Faculty</th>
                        <th>Course Time</th>
                        <th>Room</th>
                        <th>Available Seats</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="courseTableBody">
                    <tr>
                        <td colspan="9">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Routine Generator Modal -->
    <div class="modal fade" id="routineModal" tabindex="-1" aria-labelledby="routineModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="routineModalLabel">Your Class Routine</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="routine-container">
                        <table id="routineTable" class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th><span class="time-abbr">08:00-09:30</span></th>
                                    <th><span class="time-abbr">09:40-11:10</span></th>
                                    <th><span class="time-abbr">11:20-12:50</span></th>
                                    <th><span class="time-abbr">01:00-02:30</span></th>
                                    <th><span class="time-abbr">02:40-04:10</span></th>
                                    <th><span class="time-abbr">04:20-05:50</span></th>
                                    <th><span class="time-abbr">06:00-07:30</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="day-cell">Sunday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="day-cell">Monday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="day-cell">Tuesday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="day-cell">Wednesday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="day-cell">Thursday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="day-cell">Friday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="day-cell">Saturday</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="savePdfBtn">
                        <i class="bi bi-file-earmark-pdf me-1"></i> Save as PDF
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store the course data
        let courseData = [];
        let oldCourseData = [];
        let filteredData = [];
        let isViewingChanges = false;
        let isViewingStarred = false;
        let starredCourses = new Set();

        // Load starred courses from localStorage
        function loadStarredCourses() {
            const saved = localStorage.getItem('starredCourses');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    starredCourses = new Set(parsed);
                } catch (e) {
                    console.error('Error loading starred courses:', e);
                    starredCourses = new Set();
                }
            }
        }

        // Save starred courses to localStorage
        function saveStarredCourses() {
            localStorage.setItem('starredCourses', JSON.stringify([...starredCourses]));
        }

        // Toggle star status for a course
        function toggleStar(courseIdentifier) {
            // Get the star button element
            const starBtn = document.querySelector(`.star-btn[data-id="${courseIdentifier}"]`);

            if (starredCourses.has(courseIdentifier)) {
                starredCourses.delete(courseIdentifier);
                if (starBtn) {
                    starBtn.innerHTML = '<i class="bi bi-star"></i>';
                    starBtn.classList.remove('starred');
                }
            } else {
                starredCourses.add(courseIdentifier);
                if (starBtn) {
                    starBtn.innerHTML = '<i class="bi bi-star-fill"></i>';
                    starBtn.classList.add('starred');
                }
            }

            // Only re-filter if we're viewing starred courses
            if (isViewingStarred) {
                filterTable();
            } else {
                // Just save without re-rendering the entire table
                saveStarredCourses();
            }
        }

        // Function to fetch course data from CSV file
        async function fetchCourseData() {
            try {
                const response = await fetch('course_data.csv');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const csvText = await response.text();
                const lines = csvText.split('\n');
                let lastUpdated = "Unknown date";

                // Check if first line contains metadata (starts with #)
                if (lines[0].trim().startsWith('#')) {
                    // Extract lastUpdated timestamp from the comment
                    const metadataLine = lines[0].trim();
                    const lastUpdatedMatch = metadataLine.match(/# lastUpdated: (.+)/);
                    if (lastUpdatedMatch && lastUpdatedMatch[1]) {
                        lastUpdated = new Date(lastUpdatedMatch[1]).toLocaleString();
                    }
                    // Remove metadata line before parsing
                    lines.shift();
                }

                // Parse the remaining CSV data
                const courses = parseCSV(lines.join('\n'));

                // Update last updated time
                document.getElementById('lastUpdated').textContent = `Last updated: ${lastUpdated}`;

                return courses;
            } catch (error) {
                console.error('Error fetching course data:', error);
                document.getElementById('courseTableBody').innerHTML = `
                    <!-- In the loading spinner row -->
                    <tr>
                        <td colspan="9">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    
                    <!-- In the error message for course data -->
                    <tr>
                        <td colspan="9" class="text-danger text-center p-4">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Error loading course data. Please check if course_data.csv exists in the same directory.
                        </td>
                    </tr>
                
                    <!-- In the no results message -->
                    <tr>
                        <td colspan="9" class="no-results">
                            <i class="bi bi-search me-2"></i>
                            No courses found matching your criteria.
                        </td>
                    </tr>
                `;
                return [];
            }
        }

        // Function to fetch old course data
        async function fetchOldCourseData() {
            try {
                const response = await fetch('OLDcourse_data.csv');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const csvText = await response.text();
                const lines = csvText.split('\n');
                let previousDataTime = "Unknown date";

                // Check if first line contains metadata (starts with #)
                if (lines[0].trim().startsWith('#')) {
                    // Extract lastUpdated timestamp from the comment
                    const metadataLine = lines[0].trim();
                    const lastUpdatedMatch = metadataLine.match(/# lastUpdated: (.+)/);
                    if (lastUpdatedMatch && lastUpdatedMatch[1]) {
                        previousDataTime = new Date(lastUpdatedMatch[1]).toLocaleString();
                    }
                    // Remove metadata line before parsing
                    lines.shift();
                }

                // Parse the remaining CSV data
                const courses = parseCSV(lines.join('\n'));

                // Update previous data timestamp
                document.getElementById('previousDataTime').textContent = previousDataTime;

                return courses;
            } catch (error) {
                console.error('Error fetching old course data:', error);
                document.getElementById('previousDataTime').textContent = "Error loading previous data";
                return [];
            }
        }

        // Function to parse CSV data more efficiently
        function parseCSV(csvText) {
            // Split by lines
            const lines = csvText.split('\n');
            if (lines.length < 2) return [];

            // Get header row and parse headers
            const headers = lines[0].split(',').map(header => header.trim());
            const headerCount = headers.length;
            const courses = [];

            // Pre-allocate array for better performance
            courses.length = lines.length - 1;

            // Process each data row
            let validCourseCount = 0;
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // Skip empty lines

                // Handle quoted values properly
                const values = parseCSVLine(lines[i]);
                if (values.length !== headerCount) continue; // Skip malformed lines

                const course = {};

                // Map each value to its corresponding header
                for (let j = 0; j < headerCount; j++) {
                    course[headers[j]] = values[j] || '';
                }

                courses[validCourseCount++] = course;
            }

            // Trim array to actual size
            courses.length = validCourseCount;

            return courses;
        }

        // Helper function to parse CSV line with quoted values
        function parseCSVLine(line) {
            const values = [];
            let inQuotes = false;
            let currentValue = '';

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"' && (i === 0 || line[i - 1] !== '\\')) {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }

            // Add the last value
            values.push(currentValue.trim());

            // Clean up quotes from values
            return values.map(value => {
                if (value.startsWith('"') && value.endsWith('"')) {
                    return value.substring(1, value.length - 1);
                }
                return value;
            });
        }

        // Function to populate the table with course data
        function populateTable(courses) {
            const tableBody = document.getElementById('courseTableBody');

            // Clear the table body
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }

            if (courses.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="9" class="no-results">
                        <i class="bi bi-search me-2"></i>
                        No courses found matching your criteria.
                    </td>
                `;
                tableBody.appendChild(row);
                return;
            }

            // Create a document fragment to batch DOM operations
            const fragment = document.createDocumentFragment();

            // Create a Set to track unique course identifiers to prevent duplicates
            const processedCourses = new Set();

            // Pre-calculate the columns we need based on view mode
            const hasChangeColumn = isViewingChanges;

            courses.forEach(course => {
                // Create a unique identifier for each course (combination of code, section, and time)
                const courseIdentifier = `${course.CourseCode}-${course.Section}-${course.CourseTime}`;

                // Skip if we've already processed this course
                if (processedCourses.has(courseIdentifier)) {
                    return;
                }

                // Add to processed set
                processedCourses.add(courseIdentifier);

                const row = document.createElement('tr');

                // Calculate available seats
                const availableSeats = parseInt(course.TotalSeat) - parseInt(course.TakenSeat);
                const status = availableSeats > 0 ? "Available" : "Full";

                // Build row HTML - more efficient than creating each cell separately
                let rowHTML = '';

                // Add change indicator cell if viewing changes
                if (hasChangeColumn && course.change) {
                    if (course.change !== 'none') {
                        let changeText = '';
                        if (course.change === 'increased') {
                            changeText = `+${course.changeDiff} seats taken`;
                        } else if (course.change === 'decreased') {
                            changeText = `-${Math.abs(course.changeDiff)} seats taken`;
                        } else if (course.change === 'filledUp') {
                            changeText = 'Filled up';
                        } else if (course.change === 'openedUp') {
                            changeText = 'Opened up';
                        }

                        rowHTML += `<td><span class="change-indicator change-${course.change}"></span>${changeText}</td>`;
                        row.classList.add('change-row');
                    } else {
                        rowHTML += '<td>No change</td>';
                    }
                }

                // Add star cell
                const isStarred = starredCourses.has(courseIdentifier);
                rowHTML += `<td class="star-column">
                    <button class="star-btn ${isStarred ? 'starred' : ''}" data-id="${courseIdentifier}">
                        <i class="bi bi-star${isStarred ? '-fill' : ''}"></i>
                    </button>
                </td>`;

                // Add other cells
                rowHTML += `
                    <td>${course.CourseCode}</td>
                    <td>${course.Section}</td>
                    <td>${course.Faculty}</td>
                    <td>${course.CourseTime}</td>
                    <td>${course.Room || "TBA"}</td>
                    <td>${availableSeats}/${course.TotalSeat}</td>
                    <td><span class="badge ${status === 'Available' ? 'badge-available' : 'badge-full'}">${status}</span></td>
                `;

                row.innerHTML = rowHTML;

                // Add event listener to the star button
                const starBtn = row.querySelector('.star-btn');
                if (starBtn) {
                    starBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleStar(courseIdentifier);
                    });
                }

                fragment.appendChild(row);
            });

            // Append all rows at once
            tableBody.appendChild(fragment);
        }

        // Function to populate filter dropdowns
        function populateFilters(courses) {
            const courseFilter = document.getElementById('courseFilter');
            const facultyFilter = document.getElementById('facultyFilter');
            const roomFilter = document.getElementById('roomFilter');

            // Clear existing options except the first one
            while (courseFilter.options.length > 1) {
                courseFilter.remove(1);
            }

            while (facultyFilter.options.length > 1) {
                facultyFilter.remove(1);
            }

            while (roomFilter.options.length > 1) {
                roomFilter.remove(1);
            }

            // Get unique course codes
            const uniqueCourses = [...new Set(courses.map(course => course.CourseCode))];
            uniqueCourses.sort();

            // Get unique faculty names
            const uniqueFaculty = [...new Set(courses.map(course => course.Faculty))];
            uniqueFaculty.sort();

            // Get unique room names
            const uniqueRooms = [...new Set(courses.map(course => course.Room).filter(room => room))];
            uniqueRooms.sort();

            // Add course options
            uniqueCourses.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                courseFilter.appendChild(option);
            });

            // Add faculty options
            uniqueFaculty.forEach(faculty => {
                const option = document.createElement('option');
                option.value = faculty;
                option.textContent = faculty;
                facultyFilter.appendChild(option);
            });

            // Add room options
            uniqueRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomFilter.appendChild(option);
            });
        }

        // Function to update statistics
        function updateStats(courses) {
            const statsContainer = document.getElementById('statsContainer');

            // Calculate statistics
            const totalCourses = courses.length;

            // Count available courses
            const availableCourses = courses.filter(course => {
                const availableSeats = parseInt(course.TotalSeat) - parseInt(course.TakenSeat);
                return availableSeats > 0;
            }).length;

            // Count full courses
            const fullCourses = totalCourses - availableCourses;

            // Count unique course codes
            const uniqueCourses = new Set(courses.map(course => course.CourseCode)).size;

            // Create stats HTML
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalCourses}</div>
                    <div class="stat-label">Total Sections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueCourses}</div>
                    <div class="stat-label">Unique Courses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${availableCourses}</div>
                    <div class="stat-label">Available Sections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${fullCourses}</div>
                    <div class="stat-label">Full Sections</div>
                </div>
            `;

            // If viewing changes, add change statistics
            if (isViewingChanges) {
                const changedCourses = courses.filter(course => course.change && course.change !== 'none');

                const increasedCourses = courses.filter(course => course.change === 'increased').length;
                const decreasedCourses = courses.filter(course => course.change === 'decreased').length;
                const filledUpCourses = courses.filter(course => course.change === 'filledUp').length;
                const openedUpCourses = courses.filter(course => course.change === 'openedUp').length;

                statsContainer.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-value">${changedCourses.length}</div>
                        <div class="stat-label">Changed Sections</div>
                    </div>
                `;

                // Update changes summary
                document.getElementById('filledUpCount').textContent = filledUpCourses;
                document.getElementById('openedUpCount').textContent = openedUpCourses;
                document.getElementById('increasedCount').textContent = increasedCourses;
                document.getElementById('decreasedCount').textContent = decreasedCourses;
                document.getElementById('totalChangesCount').textContent = changedCourses.length;
            }
        }

        // Function to compare old and new course data
        function compareCoursesData(newCourses, oldCourses) {
            // Create maps for faster lookup
            const oldCoursesMap = new Map();

            oldCourses.forEach(course => {
                const key = `${course.CourseCode}-${course.Section}-${course.CourseTime}`;
                oldCoursesMap.set(key, course);
            });

            // Process each new course to detect changes
            return newCourses.map(newCourse => {
                const key = `${newCourse.CourseCode}-${newCourse.Section}-${newCourse.CourseTime}`;
                const oldCourse = oldCoursesMap.get(key);

                // If no old course data, mark as new (though this is unlikely in this context)
                if (!oldCourse) {
                    return { ...newCourse, change: 'new', changeDiff: parseInt(newCourse.TakenSeat) };
                }

                const oldTakenSeats = parseInt(oldCourse.TakenSeat);
                const newTakenSeats = parseInt(newCourse.TakenSeat);
                const oldAvailableSeats = parseInt(oldCourse.TotalSeat) - oldTakenSeats;
                const newAvailableSeats = parseInt(newCourse.TotalSeat) - newTakenSeats;

                let change = 'none';
                const changeDiff = newTakenSeats - oldTakenSeats;

                // Determine change type
                if (oldAvailableSeats > 0 && newAvailableSeats === 0) {
                    change = 'filledUp';
                } else if (oldAvailableSeats === 0 && newAvailableSeats > 0) {
                    change = 'openedUp';
                } else if (changeDiff > 0) {
                    change = 'increased';
                } else if (changeDiff < 0) {
                    change = 'decreased';
                }

                return { ...newCourse, change, changeDiff };
            });
        }

        // Debounce function to limit how often a function can be called
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Function to filter the table based on selected filters and search term
        function filterTable() {
            const courseValue = document.getElementById('courseFilter').value;
            const facultyValue = document.getElementById('facultyFilter').value;
            const roomValue = document.getElementById('roomFilter').value;
            const statusValue = document.getElementById('statusFilter').value;
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const changeValue = isViewingChanges ? document.getElementById('changeFilter').value : '';

            // Start with all data
            let dataToFilter = courseData;

            // Create a single filter function that combines all conditions
            // This is more efficient than chaining multiple .filter() calls
            filteredData = dataToFilter.filter(course => {
                // Star filter - do this first as it's likely to exclude the most items
                if (isViewingStarred) {
                    const courseIdentifier = `${course.CourseCode}-${course.Section}-${course.CourseTime}`;
                    if (!starredCourses.has(courseIdentifier)) {
                        return false;
                    }
                }

                // Calculate available seats for status filtering
                const availableSeats = parseInt(course.TotalSeat) - parseInt(course.TakenSeat);
                const status = availableSeats > 0 ? "Available" : "Full";

                // Course code filter
                if (courseValue && course.CourseCode !== courseValue) {
                    return false;
                }

                // Faculty filter
                if (facultyValue && course.Faculty !== facultyValue) {
                    return false;
                }

                // Room filter
                if (roomValue && course.Room !== roomValue) {
                    return false;
                }

                // Status filter
                if (statusValue && status !== statusValue) {
                    return false;
                }

                // Apply change filter when viewing changes
                if (isViewingChanges && changeValue && course.change !== changeValue) {
                    return false;
                }

                // Search filter - do this last as it's the most expensive operation
                if (searchValue) {
                    const searchableText = `${course.CourseCode} ${course.Section} ${course.Faculty} ${course.CourseTime} ${course.Room || ""}`.toLowerCase();
                    if (!searchableText.includes(searchValue)) {
                        return false;
                    }
                }

                return true;
            });

            populateTable(filteredData);
            updateStats(filteredData);
        }

        // Create debounced version for search input
        const debouncedFilterTable = debounce(filterTable, 300);

        // Function to toggle between current view and changes view
        function toggleView(viewChanges) {
            isViewingChanges = viewChanges;

            // Toggle active class on buttons
            document.getElementById('viewCurrentBtn').classList.toggle('active', !viewChanges);
            document.getElementById('viewChangesBtn').classList.toggle('active', viewChanges);

            // Toggle visibility of change-related elements
            document.getElementById('changeHeader').style.display = viewChanges ? 'table-cell' : 'none';
            document.getElementById('changeFilterContainer').style.display = viewChanges ? 'block' : 'none';
            document.getElementById('changesSummary').style.display = viewChanges ? 'block' : 'none';

            // Update the data and filters
            if (viewChanges) {
                // If we haven't compared the data yet, do it now
                if (!courseData[0].hasOwnProperty('change')) {
                    courseData = compareCoursesData(courseData, oldCourseData);
                }
            }

            // Update stats and table
            updateStats(courseData);
            filterTable();
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('courseTableBody').innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Initialize the application with loading indicators
        async function initialize() {
            // Load starred courses from localStorage
            loadStarredCourses();

            // Show loading indicator
            showLoading();

            // Fetch course data
            courseData = await fetchCourseData();

            // Set filtered data initially to all data
            filteredData = [...courseData];

            // Populate filters and table
            populateFilters(courseData);
            populateTable(filteredData);
            updateStats(filteredData);

            // Setup event listeners
            setupEventListeners();

            // Fetch old course data in the background
            oldCourseData = await fetchOldCourseData();

            // Update comparison stats if needed
            if (isViewingChanges) {
                updateComparisonStats();
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Add event listeners for filters and search
            document.getElementById('courseFilter').addEventListener('change', filterTable);
            document.getElementById('facultyFilter').addEventListener('change', filterTable);
            document.getElementById('roomFilter').addEventListener('change', filterTable);
            document.getElementById('statusFilter').addEventListener('change', filterTable);
            document.getElementById('searchInput').addEventListener('input', debouncedFilterTable);
            document.getElementById('changeFilter').addEventListener('change', filterTable);

            // Add event listeners for view toggle buttons
            document.getElementById('viewCurrentBtn').addEventListener('click', () => toggleView(false));
            document.getElementById('viewChangesBtn').addEventListener('click', () => toggleView(true));

            // Add event listener for starred courses button
            document.getElementById('viewStarredBtn').addEventListener('click', function () {
                isViewingStarred = !isViewingStarred;
                this.classList.toggle('active');

                if (isViewingStarred) {
                    this.innerHTML = '<i class="bi bi-star-fill me-1"></i> Show All Courses';
                } else {
                    this.innerHTML = '<i class="bi bi-star-fill me-1"></i> View Starred Courses';
                }

                filterTable();
            });

            // Add event listener for generate routine button
            document.getElementById('generateRoutineBtn').addEventListener('click', generateRoutine);

            // Add event listener for PDF export
            document.getElementById('savePdfBtn').addEventListener('click', exportRoutineToPDF);
        }

        // Update comparison stats
        function updateComparisonStats() {
            if (courseData.length > 0 && oldCourseData.length > 0) {
                courseData = compareCoursesData(courseData, oldCourseData);
                filterTable();
            }
        }

        // Generate routine based on starred courses
        function generateRoutine() {
            // Clear the routine table first
            const routineTable = document.getElementById('routineTable');
            const rows = routineTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td:not(.day-cell)');
                cells.forEach(cell => {
                    cell.innerHTML = '';
                    cell.colSpan = 1;
                    cell.className = '';
                    cell.style.display = '';
                });
            });

            // Get starred courses from the current course data
            const starredCourseIds = [...starredCourses];
            const starredCourseObjects = courseData.filter(course =>
                starredCourseIds.includes(`${course.CourseCode}-${course.Section}-${course.CourseTime}`)
            );

            // If no starred courses, show message
            if (starredCourseObjects.length === 0) {
                const modalBody = document.querySelector('#routineModal .modal-body');
                modalBody.innerHTML = '<div class="alert alert-warning">No starred courses found. Please star some courses first.</div>';
                return;
            }

            // Map day codes to row indices
            const dayMap = {
                'S': 0, // Sunday
                'M': 1, // Monday
                'T': 2, // Tuesday
                'W': 3, // Wednesday
                'R': 4, // Thursday
                'F': 5, // Friday
                'A': 6  // Saturday
            };

            // Map time slots to column indices
            const timeSlots = [
                '08:00 AM - 09:30 AM',
                '09:40 AM - 11:10 AM',
                '11:20 AM - 12:50 PM',
                '01:00 PM - 02:30 PM',
                '02:40 PM - 04:10 PM',
                '04:20 PM - 05:50 PM',
                '06:00 PM - 07:30 PM'
            ];

            // Process each starred course
            starredCourseObjects.forEach(course => {
                // Extract days and time from CourseTime
                const timePattern = /(\d+:\d+ [AP]M) - (\d+:\d+ [AP]M) ([A-Z]+)/;
                const match = course.CourseTime.match(timePattern);

                if (match) {
                    const startTime = match[1];
                    const endTime = match[2];
                    const days = match[3];

                    // Find the column index for the time slot
                    let startCol = -1;
                    let endCol = -1;
                    let colspan = 1;

                    for (let i = 0; i < timeSlots.length; i++) {
                        if (timeSlots[i].includes(startTime)) {
                            startCol = i;
                        }
                        if (timeSlots[i].includes(endTime)) {
                            endCol = i;
                        }
                    }

                    // Calculate colspan if needed
                    if (startCol !== -1 && endCol !== -1 && startCol !== endCol) {
                        colspan = endCol - startCol + 1;
                    }

                    // Add the course to each day's schedule
                    for (let i = 0; i < days.length; i++) {
                        const day = days[i];
                        const rowIndex = dayMap[day];

                        if (rowIndex !== undefined && startCol !== -1) {
                            const row = rows[rowIndex];
                            const cells = row.querySelectorAll('td:not(.day-cell)');

                            // Check if the cell is already occupied
                            let cellOccupied = false;
                            for (let j = startCol; j < startCol + colspan; j++) {
                                if (cells[j] && cells[j].innerHTML !== '') {
                                    cellOccupied = true;
                                    break;
                                }
                            }

                            if (!cellOccupied) {
                                // Clear any cells that will be spanned
                                for (let j = startCol + 1; j < startCol + colspan; j++) {
                                    if (cells[j]) {
                                        cells[j].innerHTML = '';
                                        cells[j].style.display = 'none';
                                    }
                                }

                                // Set the course in the cell
                                if (cells[startCol]) {
                                    cells[startCol].innerHTML = `
                                        <div class="course-cell">
                                            <strong>${course.CourseCode}</strong>.${course.Section}<br>
                                            ${course.Faculty}<br>
                                            Room: ${course.Room || "TBA"}
                                        </div>
                                    `;
                                    cells[startCol].colSpan = colspan;
                                    cells[startCol].className = 'course-cell';
                                }
                            }
                        }
                    }
                }
            });

            // Show the modal with the routine
            const routineModal = new bootstrap.Modal(document.getElementById('routineModal'));
            routineModal.show();
        }

        // Function to export routine as PDF
        function exportRoutineToPDF() {
            // Show loading indicator
            const modalBody = document.querySelector('#routineModal .modal-body');
            const originalContent = modalBody.innerHTML;
            modalBody.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating PDF...</span>
                    </div>
                    <p class="mt-2">Generating PDF, please wait...</p>
                </div>
            `;

            // Short delay to allow the loading indicator to render
            setTimeout(() => {
                // Restore original content
                modalBody.innerHTML = originalContent;

                const routineTable = document.getElementById('routineTable');
                const routineTitle = "Class Routine";

                // Use html2canvas to capture the table as an image
                html2canvas(routineTable, {
                    scale: 2, // Higher scale for better quality
                    backgroundColor: '#091428',
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');

                    // Initialize jsPDF
                    const { jsPDF } = window.jspdf;

                    // Create PDF in landscape orientation
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // Calculate dimensions to fit the image properly
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    // Add title
                    pdf.setFontSize(16);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(routineTitle, pdf.internal.pageSize.getWidth() / 2, 15, { align: 'center' });

                    // Add image of the table
                    pdf.addImage(imgData, 'PNG', 10, 20, pdfWidth - 20, pdfHeight - 10);

                    // Add footer with date
                    const date = new Date().toLocaleDateString();
                    pdf.setFontSize(10);
                    pdf.text(`Generated on: ${date}`, pdf.internal.pageSize.getWidth() - 15, pdf.internal.pageSize.getHeight() - 10, { align: 'right' });

                    // Save the PDF
                    pdf.save('class_routine.pdf');
                });
            }, 100);
        }

        // Initialize the page when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>

</html>